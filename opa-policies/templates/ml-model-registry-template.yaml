apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: mlmodelregistry
spec:
  crd:
    spec:
      names:
        kind: MLModelRegistry
      validation:
        openAPIV3Schema:
          type: object
          properties:
            registries:
              type: array
              items:
                type: string
              default: ["mlflow", "kubeflow", "sagemaker"]
            environments:
              type: array
              items:
                type: string
              default: ["production", "staging"]
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package mlmodelregistry
        
        is_ml_workload {
          input.review.object.metadata.labels["model-version"]
        }
        
        requires_registry {
          input.parameters.environments[_] = input.review.object.metadata.labels.environment
        }
        
        has_valid_registry {
          input.review.object.metadata.annotations["model-registry-url"]
          contains(input.review.object.metadata.annotations["model-registry-url"], "://")
        }
        
        violation[{"msg": msg}] {
          is_ml_workload
          requires_registry
          not has_valid_registry
          
          msg := sprintf("⚠️ ML MODEL REGISTRY VIOLATION\nDeployment: %v\nEnvironment: %v\nModel Version: %v\nCOMPLIANCE FAILURE: Production ML models must be deployed from a model registry.\nRequired annotation: model-registry-url\nExample: mlflow://models/sentiment-analyzer/v2.1.0", [input.review.object.metadata.name, input.review.object.metadata.labels.environment, input.review.object.metadata.labels["model-version"]])
        }